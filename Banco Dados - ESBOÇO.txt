CREATE TABLE USUARIOS (
    ID_USUARIO SERIAL PRIMARY KEY,
    NOME VARCHAR(150) NOT NULL,
    EMAIL VARCHAR(150) NOT NULL UNIQUE,
    SENHA VARCHAR(255) NOT NULL, 
    FOTO_PERFIL TEXT, 
    DATA_ULTIMO_LOGIN TIMESTAMP WITHOUT TIME ZONE,
    DATA_ULTIMA_REVISAO_GERAL DATE,
	CRIADO_EM TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

select 
	us.nome,
	dp.nome,
	dp.valor_total,
	dp.tipo_despesa,
	dp.tipo_transacao,
	ct.nome,
	ct.descricao,
	ct.nivel,
	fp.nome as "Forma de Pagamento"
from usuarios us
inner join despesas dp on dp.fk_id_usuario = us.id_usuario
inner join categorias ct on ct.id_categoria = dp.fk_id_categoria
inner join FORMA_PAGAMENTO fp on fp.id_forma_pagamento = dp.fk_id_forma_pagamento
where us.id_usuario = 1;


select * from despesas;

CREATE TABLE DESPESAS (
    ID_DESPESA SERIAL PRIMARY KEY,
    NOME VARCHAR(150) NOT NULL,
    VALOR_TOTAL NUMERIC(10, 2) NOT NULL CHECK (VALOR_TOTAL > 0),
    DATA_DESPESA DATE NOT NULL DEFAULT CURRENT_DATE,
    TIPO_DESPESA VARCHAR(20) NOT NULL CHECK (TIPO_DESPESA IN ('FIXA', 'ADICIONAL')),
    TIPO_TRANSACAO VARCHAR(20) NOT NULL CHECK (TIPO_TRANSACAO IN ('CREDITO', 'DEBITO')),
    PARCELAS_TOTAIS INTEGER,
	DATA_ULTIMA_ATIVIDADE_CONFIRMADA DATE,
    DATA_PRIMEIRA_PARCELA DATE,
    FK_ID_USUARIO INTEGER NOT NULL REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE,
    FK_ID_CATEGORIA INTEGER NOT NULL REFERENCES CATEGORIAS(ID_CATEGORIA) ON DELETE RESTRICT,
    FK_ID_FORMA_PAGAMENTO INTEGER NOT NULL REFERENCES FORMA_PAGAMENTO(ID_FORMA_PAGAMENTO) ON DELETE RESTRICT
);

CREATE TABLE CATEGORIAS (
    ID_CATEGORIA SERIAL PRIMARY KEY,
    NOME VARCHAR(100) NOT NULL,
    DESCRICAO TEXT,
	NIVEL VARCHAR(20) NOT NULL CHECK (NIVEL IN ('ALTA', 'MEDIA', 'BAIXA'))
);

CREATE TABLE FORMA_PAGAMENTO (
    ID_FORMA_PAGAMENTO SERIAL PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL UNIQUE -- 'CARTÃO', 'DINHEIRO', 'PIX'
);


CREATE TABLE REFRESH_TOKENS (
    ID SERIAL PRIMARY KEY,
    TOKEN TEXT NOT NULL UNIQUE,
    EXPIRES TIMESTAMP WITH TIME ZONE NOT NULL,
    CREATED TIMESTAMP WITH TIME ZONE NOT NULL,
    CREATED_BY_IP TEXT,
    IS_REVOKED BOOLEAN NOT NULL DEFAULT FALSE,
    REVOKED TIMESTAMP WITH TIME ZONE,
    REVOKED_BY_IP TEXT,
    REASON_REVOKED TEXT,
    USUARIO_ID INT NOT NULL,
    CONSTRAINT FK_USUARIO
        FOREIGN KEY(USUARIO_ID)
        REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE
);


CREATE TABLE RECUPERACAO_SENHA (
    ID_RECUPERACAO INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODIGO VARCHAR(10) NOT NULL,
    DATA_EXPIRACAO TIMESTAMP NOT NULL,
    USADO BOOLEAN DEFAULT FALSE,
    TOKEN_TEMPORARIO VARCHAR(255),
    TOKEN_EXPIRACAO TIMESTAMP,
    USUARIO_ID INT NOT NULL,
    CONSTRAINT FK_USUARIO
		FOREIGN KEY(USUARIO_ID)
		REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE
);

INSERT INTO CATEGORIAS (NOME, DESCRICAO, NIVEL) 
VALUES ('MORADIA', 'ALUGUEL, CONDOMÍNIO, FINANCIAMENTO, IPTU, TAXA DE LIXO.', 'ALTA'), ('CONTAS DE CONSUMO', 'ÁGUA, LUZ, GÁS, INTERNET, TELEFONE FIXO/MÓVEL.', 'MEDIA'), ('TRANSPORTE', 'GASOLINA, PASSES (ÔNIBUS, METRÔ), MANUTENÇÃO VEICULAR, SEGURO DO CARRO, UBER/TÁXI.', 'ALTA'), ('ALIMENTAÇÃO', 'SUPERMERCADO/HORTIFRÚTI, RESTAURANTES, DELIVERY, LANCHES.', 'ALTA'), ('SAÚDE', 'PLANOS DE SAÚDE, CONSULTAS, MEDICAMENTOS, ACADEMIA.', 'MEDIA'), ('EDUCAÇÃO', 'MENSALIDADES ESCOLARES/UNIVERSITÁRIAS, CURSOS, MATERIAIS DIDÁTICOS.', 'ALTA'), ('SERVIÇOS & ASSINATURAS', 'NETFLIX, SPOTIFY, SOFTWARE, ACADEMIA (SE NÃO CLASSIFICADA EM SAÚDE), TV A CABO.', 'ALTA'), ('LAZER E VIAGENS', 'CINEMAS, SHOWS, PASSEIOS, HOSPEDAGEM, PASSAGENS AÉREAS.', 'BAIXA'), ('VESTUÁRIO', 'ROUPAS, CALÇADOS, ACESSÓRIOS.', 'BAIXA'), ('IMPOSTOS E TAXAS', 'IPVA, IRRF, OUTRAS TAXAS GOVERNAMENTAIS (EXCLUINDO IPTU/IPVA).', 'MEDIA'), ('OUTRAS DESPESAS FIXAS', 'QUALQUER DESPESA FIXA QUE NÃO SE ENCAIXE NAS CATEGORIAS ACIMA.', 'ALTA'), ('OUTRAS DESPESAS', 'QUALQUER GASTO ADICIONAL/VARIÁVEL QUE NÃO SE ENCAIXE.', 'BAIXA');

INSERT INTO FORMA_PAGAMENTO (NOME) 
VALUES ('CARTAO'), ('DINHEIRO'), ('PIX');

select * from CATEGORIAS; 

SELECT SUM(valor_total) 
FROM despesas 
WHERE fk_id_usuario = [ID_DO_USUÁRIO] 
  AND EXTRACT(MONTH FROM data_despesa) = 12 
  AND EXTRACT(YEAR FROM data_despesa) = 2025;


