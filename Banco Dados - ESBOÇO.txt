CREATE TABLE USUARIOS (
    ID_USUARIO SERIAL PRIMARY KEY,
    NOME VARCHAR(150) NOT NULL,
    EMAIL VARCHAR(150) NOT NULL UNIQUE,
    SENHA VARCHAR(255) NOT NULL, 
    FOTO_PERFIL TEXT, 
    DATA_ULTIMO_LOGIN TIMESTAMP WITHOUT TIME ZONE,
    DATA_ULTIMA_REVISAO_GERAL DATE,
	CRIADO_EM TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE USUARIOS
ADD COLUMN STRIPE_CUSTOMER_ID VARCHAR(100),
ADD COLUMN PLANO_ATUAL VARCHAR(20) DEFAULT 'FREE';

ALTER TABLE USUARIOS
ADD CONSTRAINT check_plano 
CHECK (PLANO_ATUAL IN ('FREE', 'PRO'));

ALTER TABLE USUARIOS
ADD COLUMN DATA_VENCIMENTO_PRO TIMESTAMP;

CREATE INDEX idx_usuarios_vencimento ON USUARIOS(DATA_VENCIMENTO_PRO);

select 
	us.nome,
	dp.nome,
	dp.valor_total,
	dp.tipo_despesa,
	dp.tipo_transacao,
	ct.nome,
	ct.descricao,
	ct.nivel,
	fp.nome as "Forma de Pagamento"
from usuarios us
inner join despesas dp on dp.fk_id_usuario = us.id_usuario
inner join categorias ct on ct.id_categoria = dp.fk_id_categoria
inner join FORMA_PAGAMENTO fp on fp.id_forma_pagamento = dp.fk_id_forma_pagamento
where us.id_usuario = 1;


select * from usuarios;

CREATE TABLE DESPESAS (
    ID_DESPESA SERIAL PRIMARY KEY,
    NOME VARCHAR(150) NOT NULL,
    VALOR_TOTAL NUMERIC(10, 2) NOT NULL CHECK (VALOR_TOTAL > 0),
    DATA_DESPESA DATE NOT NULL DEFAULT CURRENT_DATE,
    TIPO_DESPESA VARCHAR(20) NOT NULL CHECK (TIPO_DESPESA IN ('FIXA', 'ADICIONAL')),
    TIPO_TRANSACAO VARCHAR(20) NOT NULL CHECK (TIPO_TRANSACAO IN ('CREDITO', 'DEBITO')),
    PARCELAS_TOTAIS INTEGER,
	DATA_ULTIMA_ATIVIDADE_CONFIRMADA DATE,
    DATA_PRIMEIRA_PARCELA DATE,
    FK_ID_USUARIO INTEGER NOT NULL REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE,
    FK_ID_CATEGORIA INTEGER NOT NULL REFERENCES CATEGORIAS(ID_CATEGORIA) ON DELETE RESTRICT,
    FK_ID_FORMA_PAGAMENTO INTEGER NOT NULL REFERENCES FORMA_PAGAMENTO(ID_FORMA_PAGAMENTO) ON DELETE RESTRICT
);

DELETE FROM DESPESAS 
WHERE FK_ID_USUARIO = 1;

SELECT SUM(valor_total) 
FROM despesas 
WHERE fk_id_usuario = FK_ID_USUARIO
  AND EXTRACT(MONTH FROM data_despesa) = 12 
  AND EXTRACT(YEAR FROM data_despesa) = 2025;

  SELECT 
    COALESCE(SUM(VALOR_TOTAL), 0)
FROM 
    DESPESAS
WHERE 
    FK_ID_USUARIO = 1
    AND EXTRACT(YEAR FROM DATA_DESPESA) = EXTRACT(YEAR FROM CURRENT_DATE)
    AND EXTRACT(MONTH FROM DATA_DESPESA) = EXTRACT(MONTH FROM CURRENT_DATE);

CREATE TABLE CATEGORIAS (
    ID_CATEGORIA SERIAL PRIMARY KEY,
    NOME VARCHAR(100) NOT NULL,
    DESCRICAO TEXT,
	NIVEL VARCHAR(20) NOT NULL CHECK (NIVEL IN ('ALTA', 'MEDIA', 'BAIXA'))
);

CREATE TABLE FORMA_PAGAMENTO (
    ID_FORMA_PAGAMENTO SERIAL PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL UNIQUE -- 'CARTÃO', 'DINHEIRO', 'PIX'
);

CREATE TABLE PLANOS (
    ID_PLANO SERIAL PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL UNIQUE, 
    DESCRICAO TEXT,
    PRECO DECIMAL(10,2) NOT NULL,
    STRIPE_PRICE_ID VARCHAR(100),
    CRIADO_EM TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO PLANOS (NOME, PRECO)
VALUES ('FREE', 0);

INSERT INTO PLANOS (NOME, PRECO, STRIPE_PRICE_ID)
VALUES ('PRO', 9.90, 'price_xxx');


UPDATE PLANOS 
SET STRIPE_PRICE_ID = 'price_1SvJBCLYWoh62EDmB3HafBVx' 
WHERE NOME = 'PRO';

select * from planos;

CREATE TABLE ASSINATURAS (
    ID_ASSINATURA SERIAL PRIMARY KEY,
    ID_USUARIO INT REFERENCES USUARIOS(ID_USUARIO),
    ID_PLANO INT REFERENCES PLANOS(ID_PLANO),

    STRIPE_SUBSCRIPTION_ID VARCHAR(100) UNIQUE,
    STATUS VARCHAR(30) NOT NULL,

    PERIODO_INICIO TIMESTAMP,
    PERIODO_FIM TIMESTAMP,

    CRIADO_EM TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ATUALIZADO_EM TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE REFRESH_TOKENS (
    ID SERIAL PRIMARY KEY,
    TOKEN TEXT NOT NULL UNIQUE,
    EXPIRES TIMESTAMP WITH TIME ZONE NOT NULL,
    CREATED TIMESTAMP WITH TIME ZONE NOT NULL,
    CREATED_BY_IP TEXT,
    IS_REVOKED BOOLEAN NOT NULL DEFAULT FALSE,
    REVOKED TIMESTAMP WITH TIME ZONE,
    REVOKED_BY_IP TEXT,
    REASON_REVOKED TEXT,
    USUARIO_ID INT NOT NULL,
    CONSTRAINT FK_USUARIO
        FOREIGN KEY(USUARIO_ID)
        REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE
);

select * from REFRESH_TOKENS;

CREATE TABLE RECUPERACAO_SENHA (
    ID_RECUPERACAO INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODIGO VARCHAR(10) NOT NULL,
    DATA_EXPIRACAO TIMESTAMP NOT NULL,
    USADO BOOLEAN DEFAULT FALSE,
    TOKEN_TEMPORARIO VARCHAR(255),
    TOKEN_EXPIRACAO TIMESTAMP,
    USUARIO_ID INT NOT NULL,
    CONSTRAINT FK_USUARIO
		FOREIGN KEY(USUARIO_ID)
		REFERENCES USUARIOS(ID_USUARIO) ON DELETE CASCADE
);

INSERT INTO CATEGORIAS (NOME, DESCRICAO, NIVEL) 
VALUES ('MORADIA', 'ALUGUEL, CONDOMÍNIO, FINANCIAMENTO, IPTU, TAXA DE LIXO.', 'ALTA'), ('CONTAS DE CONSUMO', 'ÁGUA, LUZ, GÁS, INTERNET, TELEFONE FIXO/MÓVEL.', 'MEDIA'), ('TRANSPORTE', 'GASOLINA, PASSES (ÔNIBUS, METRÔ), MANUTENÇÃO VEICULAR, SEGURO DO CARRO, UBER/TÁXI.', 'ALTA'), ('ALIMENTAÇÃO', 'SUPERMERCADO/HORTIFRÚTI, RESTAURANTES, DELIVERY, LANCHES.', 'ALTA'), ('SAÚDE', 'PLANOS DE SAÚDE, CONSULTAS, MEDICAMENTOS, ACADEMIA.', 'MEDIA'), ('EDUCAÇÃO', 'MENSALIDADES ESCOLARES/UNIVERSITÁRIAS, CURSOS, MATERIAIS DIDÁTICOS.', 'ALTA'), ('SERVIÇOS & ASSINATURAS', 'NETFLIX, SPOTIFY, SOFTWARE, ACADEMIA (SE NÃO CLASSIFICADA EM SAÚDE), TV A CABO.', 'ALTA'), ('LAZER E VIAGENS', 'CINEMAS, SHOWS, PASSEIOS, HOSPEDAGEM, PASSAGENS AÉREAS.', 'BAIXA'), ('VESTUÁRIO', 'ROUPAS, CALÇADOS, ACESSÓRIOS.', 'BAIXA'), ('IMPOSTOS E TAXAS', 'IPVA, IRRF, OUTRAS TAXAS GOVERNAMENTAIS (EXCLUINDO IPTU/IPVA).', 'MEDIA'), ('OUTRAS DESPESAS FIXAS', 'QUALQUER DESPESA FIXA QUE NÃO SE ENCAIXE NAS CATEGORIAS ACIMA.', 'ALTA'), ('OUTRAS DESPESAS', 'QUALQUER GASTO ADICIONAL/VARIÁVEL QUE NÃO SE ENCAIXE.', 'BAIXA');

INSERT INTO FORMA_PAGAMENTO (NOME) 
VALUES ('CARTAO'), ('DINHEIRO'), ('PIX');

select * from CATEGORIAS; 




